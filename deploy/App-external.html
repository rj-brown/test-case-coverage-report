<!DOCTYPE html>
<html>
<head>
    <title>CustomApp</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"exportBtn",cls:"export-button"},{xtype:"container",itemId:"successCriteriaCombobox",cls:"success-criteria-combo-box"},{xtype:"container",itemId:"milestoneCombobox",cls:"milestone-combo-box"},{xtype:"container",itemId:"gridContainer"}],launch:function(){this._myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Loading data..."}),this._myMask.show(),this.down("#successCriteriaCombobox").add({xtype:"rallyfieldvaluecombobox",itemId:"successCriteriaCombobox",model:"UserStory",field:"c_SuccessCriteria",allowNoEntry:!0,noEntryText:"All Success Criteria",listeners:{scope:this,select:this._onSelect}}),this.down("#milestoneCombobox").add({xtype:"rallymilestonecombobox",itemId:"stateComboBox",allowNoEntry:!0,noEntryText:"All Milestones",model:["userstory"],listeners:{scope:this,select:this._onSelect,ready:this._initStore}})},_getMultiFilter:function(){var successCriteriaFilter,milestoneFilter;if("All Success Criteria"!==this.down("#successCriteriaCombobox").items.items[0].rawValue){var successCriteriaValue="";successCriteriaValue="Yes"===this.down("#successCriteriaCombobox").items.items[0].rawValue?!0:!1,successCriteriaFilter={property:"FeatureUserStorySuccessCriteria",operator:"=",value:successCriteriaValue}}return"All Milestones"!==this.down("#stateComboBox").getRawValue()&&(milestoneFilter={property:"FeatureMilestones",operator:"=",value:this.down("#stateComboBox").getRawValue()}),milestoneFilter||successCriteriaFilter?milestoneFilter&&successCriteriaFilter?Ext.create("Rally.data.QueryFilter",milestoneFilter).and(Ext.create("Rally.data.QueryFilter",successCriteriaFilter)):!milestoneFilter&&successCriteriaFilter?Ext.create("Rally.data.QueryFilter",successCriteriaFilter):Ext.create("Rally.data.QueryFilter",milestoneFilter):(this._grid.getStore().reload(),void 0)},_onSelect:function(){var store=this._grid.getStore();store.clearFilter(!0),store.filter(this._getMultiFilter())},_initStore:function(){Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Feature",autoLoad:!0,remoteSort:!1,fetch:!0,limit:1/0,listeners:{load:this._onDataLoaded,scope:this}})},_onDataLoaded:function(store,data){0===data.length&&this._makeGrid(data);var features=[],promises=[],userStoryStore="",testCaseStore="";_.each(data,function(feature,index){var f={FormattedID:feature.get("FormattedID"),_ref:feature.get("_ref"),FeatureNumericID:Number(feature.get("FormattedID").replace(/\D+/g,"")),FeatureName:feature.get("Name"),FeatureRelease:"",FeatureState:"",FeatureWorkItemType:feature.get("c_WorkItemType"),UserStories:[],TestCases:[],FeatureMilestones:[]};if("Functional"===f.FeatureWorkItemType){if(feature.data.Release&&(f.FeatureRelease=feature.data.Release._refObjectName,f.FeatureReleaseNumericID="Unscheduled"!==f.FeatureRelease?Number(f.FeatureRelease.replace(/\D+/g,"")):0),feature.data.State&&(f.FeatureState=feature.data.State._refObjectName),feature.data.Milestones&&feature.data.Milestones.Count>0){var milestones=[];_.each(feature.data.Milestones._tagsNameArray,function(milestone){milestones.push(milestone.Name)}),f.FeatureMilestones=milestones.join(", ")}userStoryStore=feature.getCollection("UserStories",{fetch:["FormattedID","Name","ScheduleState","c_SuccessCriteria","TestCases"]}).load({callback:function(records){_.each(records,function(userstory){var reference=userstory.get("FormattedID");f.UserStories.push({_ref:userstory.get("_ref"),FormattedID:reference,StoryNumericID:Number(userstory.get("FormattedID").replace(/\D+/g,"")),Name:userstory.get("Name"),ScheduleState:userstory.get("ScheduleState"),TestCaseCount:userstory.get("TestCases").Count,SuccessCriteria:userstory.get("c_SuccessCriteria")}),testCaseStore=userstory.getCollection("TestCases",{fetch:["FormattedID","Name"]}).load({callback:function(records){_.each(records,function(testcase){f.TestCases.push({_ref:testcase.get("_ref"),FormattedID:testcase.get("FormattedID"),Name:testcase.get("Name"),StoryName:reference})},this)},scope:this})},this)},scope:this}),features.push(f),promises.push(userStoryStore,testCaseStore)}else index===data.length-1&&0===features.length&&this._makeGrid(features)},this),Deft.Promise.all(promises).then({success:function(){this._makeGrid(this._createMatrix(features))},scope:this})},_createMatrix:function(data){var rows=[];return _.each(data,function(row){row.UserStories.length>0&&_.each(row.UserStories,function(story){var r={_ref:row._ref,FormattedID:row.FormattedID,FeatureName:row.FeatureName,FeatureNumericID:row.FeatureNumericID,FeatureMilestones:row.FeatureMilestones,FeatureRelease:row.FeatureRelease,FeatureReleaseNumericID:row.FeatureReleaseNumericID,FeatureState:row.FeatureState,FeatureWorkItemType:row.FeatureWorkItemType,FeatureUserStory:[],FeatureUserStoryNumericID:"",FeatureUserStoryName:"",FeatureUserStoryState:"",FeatureUserStoryTestCaseCount:0,FeatureUserStoryTestCases:[],FeatureUserStorySuccessCriteria:""};if(row.TestCases.length>0){var count=0;_.each(row.TestCases,function(testcase){testcase.StoryName===story.FormattedID&&(++count,r.FeatureUserStoryTestCases.push({FormattedID:testcase.FormattedID,_ref:testcase._ref}))}),r.FeatureUserStoryTestCaseCount=count}r.FeatureUserStory.push({FormattedID:story.FormattedID,_ref:story._ref}),r.FeatureUserStoryNumericID=story.StoryNumericID,r.FeatureUserStoryName=story.Name,r.FeatureUserStoryState=story.ScheduleState,r.FeatureUserStorySuccessCriteria=story.SuccessCriteria,rows.push(r)})}),rows},_makeGrid:function(stories){this._myMask.hide();var store=Ext.create("Rally.data.custom.Store",{data:stories,sorters:[{property:"FeatureNumericID",direction:"ASC"},{property:"FeatureUserStoryNumericID",direction:"ASC"}],proxy:{type:"memory"}});this._stories=stories,this._grid=Ext.create("Rally.ui.grid.Grid",{itemId:"storiesGrid",store:store,showRowActionsColumn:!1,showPagingToolbar:!1,columnCfgs:[{text:"Feature ID",dataIndex:"FormattedID",xtype:"templatecolumn",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate"),getSortParam:function(){return"FeatureNumericID"}},{text:"Feature Name",dataIndex:"FeatureName",flex:1},{text:"Feature PSI",dataIndex:"FeatureRelease",width:65,getSortParam:function(){return"FeatureReleaseNumericID"}},{text:"Feature Work Item Type",dataIndex:"FeatureWorkItemType"},{text:"Feature State",dataIndex:"FeatureState"},{text:"User Story ID",dataIndex:"FeatureUserStory",renderer:function(value){return value?'<a href="'+Rally.nav.Manager.getDetailUrl(value[0])+'" target="_blank">'+value[0].FormattedID+"</a>":void 0},getSortParam:function(){return"FeatureUserStoryNumericID"}},{text:"User Story Name",dataIndex:"FeatureUserStoryName",flex:1},{text:"Story Schedule State",dataIndex:"FeatureUserStoryState"},{text:"Test Case Count",dataIndex:"FeatureUserStoryTestCaseCount",sortable:!1},{text:"Test Case ID",dataIndex:"FeatureUserStoryTestCases",renderer:function(value){var html=[];return Ext.Array.each(value,function(testcase){html.push('<a href="'+Rally.nav.Manager.getDetailUrl(testcase)+'" target="_blank">'+testcase.FormattedID+"</a>")}),html.join("</br>")},getSortParam:function(){return"TestCaseCount"}}]}),this.down("#gridContainer").add(this._grid),this.down("#exportBtn").add({xtype:"rallybutton",text:"Export to CSV",href:"data:text/csv;charset=utf8,"+encodeURIComponent(this._getCSV()),id:"exportButton",scope:this}),document.getElementById("exportButton").setAttribute("download","export.csv")},_getCSV:function(){var cols=this._grid.columns,data="";return _.each(cols,function(col){data+=this._getFieldTextAndEscape(col.text)+","},this),data+="Milestones,",data+="\r\n",_.each(this._stories,function(record){var rowData="";_.each(cols,function(col){var text="",fieldName=col.dataIndex;"FeatureUserStoryTestCaseCount"===fieldName?text=""+record.FeatureUserStoryTestCaseCount:"FeatureUserStory"===fieldName?text+=record.FeatureUserStory[0].FormattedID:"FeatureUserStoryTestCases"===fieldName?data+=this._getTestCaseRowsForCSV(record.FeatureUserStoryTestCases,rowData,record.FeatureUserStoryTestCaseCount,record.FeatureMilestones):text=record[fieldName];var cleanText=this._getFieldTextAndEscape(text);data+=cleanText+",",rowData+=cleanText+","},this),data+=this._getFieldTextAndEscape(record.FeatureMilestones)+"\r\n"},this),data},_getTestCaseRowsForCSV:function(testcases,storyRowStr,testcaseCount,milestone){var testcaseRows="";return _.each(testcases,function(testcase,index){testcaseRows+=0===index?this._getFieldTextAndEscape(testcase.FormattedID):storyRowStr+this._getFieldTextAndEscape(testcase.FormattedID),testcaseCount>1&&index!==testcaseCount-1&&(testcaseRows+=","+this._getFieldTextAndEscape(milestone)+"\r\n")},this),testcaseRows},_getFieldTextAndEscape:function(fieldData){var string=this._getFieldText(fieldData);return this._escapeForCSV(string)},_getFieldText:function(fieldData){var text;return text=null!==fieldData&&void 0!==fieldData&&fieldData.match?fieldData._refObjectName?fieldData._refObjectName:fieldData:""},_escapeForCSV:function(string){return string.match(/,/)&&(string=string.match(/"/)?string.replace(/,/g,""):'"'+string+'"'),string}});

            Rally.launchApp('CustomApp', {
                name:"CustomApp",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .export-button{display:inline;float:right;width:100px}.milestone-combo-box{display:inline;float:left;width:160px}.success-criteria-combo-box{display:inline;float:left;width:160px}.x-panel-body{height:auto !important}
    </style>
</head>
<body>
</body>
</html>
